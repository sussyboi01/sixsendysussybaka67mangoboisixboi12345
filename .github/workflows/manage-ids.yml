name: Manage Allowed IDs

# Triggered by repository_dispatch (from Cloudflare Worker)
on:
  repository_dispatch:
    types: [start-task] # matches worker event_type

permissions:
  contents: write  # needed to update allowed-ids.json

jobs:
  update_ids:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repo so we can edit the JSON
      - name: Checkout Repo
        uses: actions/checkout@v3

      # Install jq for JSON editing
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Ensure allowed-ids.json exists
      - name: Initialize JSON
        run: |
          FILE="allowed-ids.json"
          if [ ! -f "$FILE" ]; then
            echo "[]" > "$FILE"
          fi

      # Update allowed-ids.json based on worker payload
      - name: Process Payload
        run: |
          FILE="allowed-ids.json"
          NAME="${{ github.event.client_payload.name }}"
          ID="${{ github.event.client_payload.id }}"
          ACTION="${{ github.event.client_payload.action }}"

          if [[ "$ACTION" == "ADD" ]]; then
            # Add new entry if it doesn't already exist
            jq --arg name "$NAME" --arg id "$ID" 'if any(.[]; .id == $id) then . else . + [{"name": $name, "id": $id}] end' "$FILE" > tmp.json
            mv tmp.json "$FILE"
          elif [[ "$ACTION" == "REMOVE" ]]; then
            # Remove entry by ID
            jq --arg id "$ID" 'map(select(.id != $id))' "$FILE" > tmp.json
            mv tmp.json "$FILE"
          else
            echo "Unknown action: $ACTION"
          fi

      # Commit and push changes
      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add allowed-ids.json
          git commit -m "Update allowed-ids.json via repository_dispatch" || echo "No changes to commit"
          git push
