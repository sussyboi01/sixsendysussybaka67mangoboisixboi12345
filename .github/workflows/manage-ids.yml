name: Manage Allowed IDs

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'add or remove'
        required: true
      name:
        description: 'Device nickname'
        required: false
      id:
        description: 'Device ID'
        required: false

permissions:
  contents: write

jobs:
  update_ids:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Initialize JSON file
      run: |
        FILE="allowed-ids.json"
        if [ ! -f "$FILE" ]; then
          echo "[]" > "$FILE"
        fi

    - name: Update JSON
      run: |
        FILE="allowed-ids.json"
        ACTION="${{ github.event.inputs.action }}"
        NAME="${{ github.event.inputs.name }}"
        ID="${{ github.event.inputs.id }}"

        if [ "$ACTION" = "add" ]; then
          echo "Adding device: $NAME = $ID"
          jq --arg name "$NAME" --arg id "$ID" '. += [{"name": $name, "id": $id}]' "$FILE" > tmp.json
          mv tmp.json "$FILE"
        elif [ "$ACTION" = "remove" ]; then
          echo "Removing device with ID: $ID"
          jq --arg id "$ID" 'map(select(.id != $id))' "$FILE" > tmp.json
          mv tmp.json "$FILE"
        else
          echo "Unknown action: $ACTION"
          exit 1
        fi

    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add allowed-ids.json
        git commit -m "Update allowed-ids.json via workflow" || echo "No changes to commit"

    - name: Push changes
      run: git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
