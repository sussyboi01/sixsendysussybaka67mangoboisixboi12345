name: Manage Allowed IDs

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  update_ids:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Initialize JSON
      run: |
        FILE="allowed-ids.json"
        if [ ! -f "$FILE" ]; then
          echo "[]" > "$FILE"
        fi

    - name: Process Issue
      run: |
        FILE="allowed-ids.json"
        TITLE="${{ github.event.issue.title }}"
        BODY="${{ github.event.issue.body }}"

        if [[ "$TITLE" == ADD-ID:* ]]; then
          NAME="${TITLE#ADD-ID: }"
          ID=$(echo "$BODY" | grep -oP '(?<=ID: ).*')
          jq --arg name "$NAME" --arg id "$ID" '. += [{"name": $name,"id": $id}]' "$FILE" > tmp.json
          mv tmp.json "$FILE"
        elif [[ "$TITLE" == REMOVE-ID:* ]]; then
          ID=$(echo "$BODY" | grep -oP '(?<=ID: ).*')
          jq --arg id "$ID" 'map(select(.id != $id))' "$FILE" > tmp.json
          mv tmp.json "$FILE"
        fi

    - name: Commit Changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add allowed-ids.json
        git commit -m "Update allowed-ids.json via issue" || echo "No changes to commit"

    - name: Push Changes
      run: git push

    - name: Close Issue
      run: gh issue close ${{ github.event.issue.number }} -R ${{ github.repository }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
