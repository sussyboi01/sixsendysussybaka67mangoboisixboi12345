<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Allowed Device Manager</title>
<style>
body { margin:0; font-family:sans-serif; background:#14142b; color:white; padding:20px; }
h1 { text-align:center; font-size:30px; text-shadow:0 0 15px #5a5aff; }
#container { max-width:700px; margin:40px auto; background:#1a1a35; padding:25px; border-radius:12px; border:2px solid #252550; box-shadow:0 0 20px rgba(90,90,255,0.5); display:none; }
.deviceItem { display:flex; align-items:center; justify-content:space-between; background:#14142b; padding:12px 15px; border-radius:10px; margin-bottom:10px; border:1px solid #252550; }
.deviceItem span { font-family:monospace; }
.removeBtn { background:#ff4a4a; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; color:white; font-size:13px; }
.removeBtn:hover { background:#ff6b6b; }
#addBox { margin-top:25px; display:flex; flex-direction:column; gap:10px; }
input, button { padding:12px; border-radius:10px; border:none; font-size:15px; }
input { background:#0e0e24; color:white; border:1px solid #272755; }
#addBtn { background:#5a5aff; color:white; cursor:pointer; font-weight:bold; text-shadow:0 0 10px rgba(255,255,255,0.3); }
#addBtn:hover { background:#7878ff; }
#deny { text-align:center; margin-top:50px; font-size:20px; display:none; }
</style>
</head>
<body>

<h1>Allowed Device Manager</h1>

<div id="deny">
    ❌ Access Denied  
    <br><br>
    wrong password lil bro
</div>

<div id="container">
    <h2>Allowed Devices</h2>
    <div id="list"></div>

    <div id="addBox">
        <input id="nickInput" placeholder="Device nickname (example: Evan's PC)">
        <input id="idInput" placeholder="Device ID (UUID)">
        <button id="addBtn">Add Device</button>
    </div>
</div>

<script>
const PASSWORD = "eaterevan123";
const WORKER_URL = "https://hiboi.hexorod0.workers.dev";

// PASSWORD CHECK
const entered = prompt("Enter admin password:");
if (entered !== PASSWORD) {
    document.getElementById("deny").style.display = "block";
    throw new Error("Incorrect password — stopping script.");
}
document.getElementById("container").style.display = "block";

// SEND DEVICE TO CLOUD WORKER
async function sendDeviceToWorker(name, id, action = "ADD") {
    try {
        const res = await fetch(`${WORKER_URL}/update-device`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, id, action })
        });
        const data = await res.json();
        console.log("Worker response:", data);
    } catch (err) {
        console.error("Failed to send device info to worker:", err);
    }
}

// LOAD CURRENT DEVICES FROM GITHUB RAW
async function loadList() {
    const url = `https://raw.githubusercontent.com/sussyboi01/sixsendysussybaka67mangoboisixboi12345/main/allowed-ids.json?t=${Date.now()}`;

    const list = document.getElementById("list");
    list.innerHTML = "<i>Loading devices…</i>";

    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`GitHub returned ${res.status}`);
        const data = await res.json();
        renderList(data);
    } catch (err) {
        console.error("Failed to load allowed-ids.json:", err);
        list.innerHTML = "<i>Failed to load devices.</i>";
    }
}

// RENDER DEVICE LIST WITH REMOVE BUTTONS
function renderList(devices) {
    const list = document.getElementById("list");
    list.innerHTML = devices.length === 0 ? "<i>No devices added yet</i>" : "";

    devices.forEach(d => {
        const div = document.createElement("div");
        div.className = "deviceItem";

        const nameSpan = document.createElement("div");
        nameSpan.innerHTML = `<b>${d.name}</b><br><span>${d.id}</span>`;

        const removeBtn = document.createElement("button");
        removeBtn.className = "removeBtn";
        removeBtn.textContent = "Remove";
        removeBtn.onclick = async () => {
            if (!confirm(`Remove device "${d.name}"?`)) return;
            await sendDeviceToWorker(d.name, d.id, "REMOVE");
            // Wait a few seconds to let GitHub Actions commit changes
            setTimeout(loadList, 3000);
        };

        div.appendChild(nameSpan);
        div.appendChild(removeBtn);
        list.appendChild(div);
    });
}

// HANDLE ADD DEVICE BUTTON
document.getElementById("addBtn").onclick = async () => {
    const name = document.getElementById("nickInput").value.trim();
    const id = document.getElementById("idInput").value.trim();
    if (!name || !id) return alert("Fill both fields!");

    await sendDeviceToWorker(name, id, "ADD");
    setTimeout(loadList, 3000); // refresh list after a short delay

    document.getElementById("nickInput").value = "";
    document.getElementById("idInput").value = "";
};

// INITIAL LOAD
loadList();
</script>
</body>
</html>
